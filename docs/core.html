---

title: fastcgi API


keywords: fastai
sidebar: home_sidebar

summary: "API details for fastcgi"
description: "API details for fastcgi"
nb_path: "00_core.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 00_core.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This library follows the <a href="http://www.mit.edu/~yandros/doc/specs/fcgi-spec.html">FastCGI spec</a>. It only supports the <em>Responder</em> role, and does not support multiplexing (which is not supported by any servers, so is unlikely to be an issue).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Helpers">Helpers<a class="anchor-link" href="#Helpers"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You probably won't need to use these helpers directly; they are made public and documented in case you want to customize anything.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>These <code>enum</code>s are used throughout the library, and have the same meanings as the <code>FCGI_</code> constants <code>#define</code>d in the spec.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">Request</span><span class="p">,</span><span class="n">Role</span><span class="p">,</span><span class="n">Status</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">o</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[&lt;Request.BEGIN_REQUEST: 1&gt;, &lt;Request.ABORT_REQUEST: 2&gt;, &lt;Request.END_REQUEST: 3&gt;, &lt;Request.PARAMS: 4&gt;, &lt;Request.STDIN: 5&gt;, &lt;Request.STDOUT: 6&gt;, &lt;Request.STDERR: 7&gt;, &lt;Request.DATA: 8&gt;, &lt;Request.GET_VALUES: 9&gt;, &lt;Request.GET_VALUES_RESULT: 10&gt;]
[&lt;Role.RESPONDER: 1&gt;, &lt;Role.AUTHORIZER: 2&gt;, &lt;Role.FILTER: 3&gt;]
[&lt;Status.REQUEST_COMPLETE: 1&gt;, &lt;Status.CANT_MPX_CONN: 2&gt;, &lt;Status.OVERLOADED: 3&gt;, &lt;Status.UNKNOWN_ROLE: 4&gt;]
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="unpack_from" class="doc_header"><code>unpack_from</code><a href="https://github.com/fastai/fastcgi/tree/master/fastcgi/core.py#L22" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>unpack_from</code>(<strong><code>fmt</code></strong>, <strong><code>s</code></strong>, <strong><code>offset</code></strong>=<em><code>0</code></em>, <strong><code>prefix</code></strong>=<em><code>'!'</code></em>)</p>
</blockquote>
<p><code>struct.unpack_from</code> with <code>prefix</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="pack" class="doc_header"><code>pack</code><a href="https://github.com/fastai/fastcgi/tree/master/fastcgi/core.py#L27" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>pack</code>(<strong><code>s</code></strong>, <strong>*<code>args</code></strong>, <strong><code>prefix</code></strong>=<em><code>'!'</code></em>)</p>
</blockquote>
<p><code>struct.pack</code> with <code>prefix</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Since fastcgi uses "network order" in its binary protocol, we define pack and unpack functions that use that default.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="pack_rec" class="doc_header"><code>pack_rec</code><a href="https://github.com/fastai/fastcgi/tree/master/fastcgi/core.py#L36" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>pack_rec</code>(<strong><code>typ</code></strong>, <strong><code>c</code></strong>=<em><code>b''</code></em>)</p>
</blockquote>
<p>Create a fastcgi binary record containing optional content <code>c</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="unpack_sz" class="doc_header"><code>unpack_sz</code><a href="https://github.com/fastai/fastcgi/tree/master/fastcgi/core.py#L42" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>unpack_sz</code>(<strong><code>fmt</code></strong>, <strong><code>s</code></strong>, <strong><code>offset</code></strong>=<em><code>0</code></em>, <strong><code>prefix</code></strong>=<em><code>'!'</code></em>)</p>
</blockquote>
<p><a href="/fastcgi/core.html#unpack_from"><code>unpack_from</code></a>, returning new <code>offset</code> based on size of <code>fmt</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="unpack_rec" class="doc_header"><code>unpack_rec</code><a href="https://github.com/fastai/fastcgi/tree/master/fastcgi/core.py#L49" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>unpack_rec</code>(<strong><code>c</code></strong>, <strong><code>i</code></strong>)</p>
</blockquote>
<p>Unpack a fastcgi binary record starting at offset <code>i</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="unpack_content" class="doc_header"><code>unpack_content</code><a href="https://github.com/fastai/fastcgi/tree/master/fastcgi/core.py#L56" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>unpack_content</code>(<strong><code>typ</code></strong>, <strong><code>c</code></strong>)</p>
</blockquote>
<p>Unpack the content section of a fastcgi binary record of <code>typ</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="FcgiHandler" class="doc_header"><code>class</code> <code>FcgiHandler</code><a href="https://github.com/fastai/fastcgi/tree/master/fastcgi/core.py#L95" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>FcgiHandler</code>(<strong><code>request</code></strong>, <strong><code>client_address</code></strong>, <strong><code>server</code></strong>) :: <code>BaseRequestHandler</code></p>
</blockquote>
<p>Base class for request handler classes.</p>
<p>This class is instantiated for each request to be handled.  The
constructor sets the instance variables request, client_address
and server, and then calls the handle() method.  To implement a
specific service, all you need to do is to derive a class which
defines a handle() method.</p>
<p>The handle() method can find the request as self.request, the
client address as self.client_address, and the server (in case it
needs access to per-server information) as self.server.  Since a
separate instance is created for each request, the handle() method
can define other arbitrary instance variables.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This is used in much the same way as <a href="https://docs.python.org/3/library/socketserver.html#request-handler-objects">BaseRequestHandler</a>, except that receiving the data is handled for you before your <code>handle</code> method is called. All headers are available in the <code>params</code> dictionary, and <code>stdin</code> contains the data sent to your handler.</p>
<p>Use <code>send</code> to send data to the client, and add <code>err=True</code> to pass it as stderr.</p>
<p>Here's an example subclass:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">TestHandler</span><span class="p">(</span><span class="n">FcgiHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;query:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;QUERY_STRING&#39;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;content type:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;HTTP_CONTENT_TYPE&#39;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;stdin:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdin</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;Content-type: text/html</span><span class="se">\r\n\r\n</span><span class="s2">&lt;html&gt;foobar&lt;/html&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To test it, we'll use an http-&gt;fcgi proxy, we can download <code>http2fcgi</code> and run it in the background as follows:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;test.sock&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>

<span class="n">run</span><span class="p">(</span><span class="s1">&#39;./get_http2fcgi.sh&#39;</span><span class="p">)</span>
<span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;./http2fcgi -fcgi unix:///</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1"> -ext py&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can now test the handler by running a server in the background...</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nd">@threaded</span>
<span class="k">def</span> <span class="nf">_f</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">socketserver</span><span class="o">.</span><span class="n">UnixStreamServer</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">TestHandler</span><span class="p">)</span> <span class="k">as</span> <span class="n">server</span><span class="p">:</span> <span class="n">server</span><span class="o">.</span><span class="n">handle_request</span><span class="p">()</span>

<span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span> <span class="n">p</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">_f</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>...and use <code>curl</code> to test it:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>curl <span class="s1">&#39;http://localhost:6065/setup.py?a=1&#39;</span> -X POST -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -d test
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>query: a=1
content type: application/json
stdin: test
&lt;html&gt;foobar&lt;/html&gt;
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Finally, we kill</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">proc</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

