---

title: fastcgi.http


keywords: fastai
sidebar: home_sidebar

summary: "Not actually fastcgi at all! A very simple HTTP handler, designed for python apps behind a reverse proxy"
description: "Not actually fastcgi at all! A very simple HTTP handler, designed for python apps behind a reverse proxy"
nb_path: "02_http.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 02_http.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">nbdev</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fastcore.utils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">time</span><span class="o">,</span><span class="nn">socket</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Python's-standard-library-servers">Python's standard library servers<a class="anchor-link" href="#Python's-standard-library-servers"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Python's <code>socketserver</code> classes call <code>handle</code> in a <code>BaseRequestHandler</code> subclass that you pass in to its constructor. You use a <code>BaseRequestHandler</code> with any of the server classes/mixins provided by <code>socketserver</code>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h3 id="ReuseThreadingServer" class="doc_header"><code>class</code> <code>ReuseThreadingServer</code><a href="https://github.com/fastai/fastcgi/tree/master/fastcgi/http.py#L10" class="source_link" style="float:right">[source]</a></h3><blockquote><p><code>ReuseThreadingServer</code>(<strong><code>server_address</code></strong>, <strong><code>RequestHandlerClass</code></strong>, <strong><code>bind_and_activate</code></strong>=<em><code>True</code></em>) :: <code>ThreadingTCPServer</code></p>
</blockquote>
<p>Mix-in class to handle each request in a new thread.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>It's easiest to use <code>allow_reuse_address</code> to avoid having to wait for sockets to close, especially when testing. This class adds that functionality to <code>ThreadingTCPServer</code>.</p>
<p>Here's an example of using Python's standard library features along with <a href="/fastcgi/http.html#ReuseThreadingServer"><code>ReuseThreadingServer</code></a>:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">host</span><span class="p">,</span><span class="n">port</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span><span class="mi">8000</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">_TestHandler</span><span class="p">(</span><span class="n">StreamRequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;received&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;pong </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">client_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nd">@startthread</span>
<span class="k">def</span> <span class="nf">_f</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">ReuseThreadingServer</span><span class="p">((</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">),</span> <span class="n">_TestHandler</span><span class="p">)</span> <span class="k">as</span> <span class="n">srv</span><span class="p">:</span> <span class="n">srv</span><span class="o">.</span><span class="n">handle_request</span><span class="p">()</span>

<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span> <span class="c1"># wait for server to start</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">c</span> <span class="o">=</span> <span class="n">start_client</span><span class="p">(</span><span class="n">port</span><span class="p">,</span><span class="n">host</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;ping</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>received b&#39;ping\r\n&#39;
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>b&#39;pong 127.0.0.1\r\n&#39;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h3 id="HandlerException" class="doc_header"><code>class</code> <code>HandlerException</code><a href="https://github.com/fastai/fastcgi/tree/master/fastcgi/http.py#L13" class="source_link" style="float:right">[source]</a></h3><blockquote><p><code>HandlerException</code>(<strong><code>code</code></strong>, <strong><code>err</code></strong>=<em><code>''</code></em>) :: <code>Exception</code></p>
</blockquote>
<p>Class for exceptions from setup of <a href="/fastcgi/http.html#MinimalHTTPHandler"><code>MinimalHTTPHandler</code></a></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="MinimalHTTPHandler" class="doc_header"><code>class</code> <code>MinimalHTTPHandler</code><a href="https://github.com/fastai/fastcgi/tree/master/fastcgi/http.py#L20" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>MinimalHTTPHandler</code>(<strong><code>request</code></strong>, <strong><code>client_address</code></strong>, <strong><code>server</code></strong>) :: <code>StreamRequestHandler</code></p>
</blockquote>
<p>Define self.rfile and self.wfile for stream sockets.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">add_docs</span><span class="p">(</span><span class="n">MinimalHTTPHandler</span><span class="p">,</span> <span class="s2">&quot;A greatly simplified version of `BaseHTTPHandler`. Overriding `handle` is required.&quot;</span><span class="p">,</span>
         <span class="n">setup</span><span class="o">=</span><span class="s2">&quot;Overriden from `BaseRequestHandler`&quot;</span><span class="p">,</span>
         <span class="n">setup_ex</span><span class="o">=</span><span class="s2">&quot;Override to handle exceptions in `setup`&quot;</span><span class="p">,</span>
         <span class="n">send_response</span><span class="o">=</span><span class="s2">&quot;Set the HTTP response code to `code`&quot;</span><span class="p">,</span>
         <span class="n">send_header</span><span class="o">=</span><span class="s2">&quot;Send a MIME header to the headers buffer&quot;</span><span class="p">,</span>
         <span class="n">end_headers</span><span class="o">=</span><span class="s2">&quot;Send the blank line ending the MIME headers&quot;</span><span class="p">,</span>
         <span class="n">MessageClass</span><span class="o">=</span><span class="s2">&quot;Class used for `http.client.parse_headers&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a href="/fastcgi/http.html#MinimalHTTPHandler"><code>MinimalHTTPHandler</code></a> parses the HTTP command and headers, and sets <code>command</code>, <code>path</code>, <code>request_version</code>, and <code>headers</code>. It is based on the code in Python's <code>BaseHTTPHandler</code>, but is greatly simplified, and made consistent with the other <code>socketserver</code> servers.</p>
<p>To send a response, call <code>send_response(code)</code>, optionally <code>send_header</code> a few times, then <code>end_headers</code>, and finally write to <code>wfile</code>. For instance:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">_TestHandler</span><span class="p">(</span><span class="n">MinimalHTTPHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Command/path/version: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">request_version</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s2">&quot;text/plain&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s1">&#39;Content-Length&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;ok&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nd">@startthread</span>
<span class="k">def</span> <span class="nf">_f</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">ReuseThreadingServer</span><span class="p">((</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span><span class="mi">8000</span><span class="p">),</span> <span class="n">_TestHandler</span><span class="p">)</span> <span class="k">as</span> <span class="n">httpd</span><span class="p">:</span> <span class="n">httpd</span><span class="o">.</span><span class="n">handle_request</span><span class="p">()</span>

<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span> <span class="c1"># wait for server to start</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">urlread</span><span class="p">(</span><span class="s2">&quot;http://localhost:8000&quot;</span><span class="p">),</span> <span class="sa">b</span><span class="s1">&#39;ok&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Command/path/version: GET / 1.1
Accept-Encoding: identity
Host: localhost:8000
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.183 Safari/537.36
Connection: close


</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

